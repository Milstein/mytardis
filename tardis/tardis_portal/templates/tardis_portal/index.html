{% extends "tardis_portal/portal_template.html" %}
{% load static from staticfiles %}
{% load experiment_tags %}
{% load experimentstats %}
{% load bleach_tag %}

{% block script %}
{% endblock script %}

{% block content %}
<div id="content">

	<div id="experiment"></div>
	{% if not is_authenticated %}
	<p>
		{% if RAPID_CONNECT_ENABLED %}
		Please <a href={{ RAPID_CONNECT_LOGIN_URL }}>login</a>
		to see your experiment data.
		{% else %}
		Please
		<a href="{% url 'tardis.tardis_portal.views.login' %}">login</a>
		to see your experiment data.
		{% endif %}
	</p>
	{% endif %}
	<div class="row-fluid">
		<div class="col-12 col-md-10">
			{% if is_authenticated %}
			<h3>Your most recent experiments <small><strong>(<a href="{% url 'tardis.tardis_portal.views.my_data' %}">view all</a>)</strong></small></h3>
			{% for exp in private_experiments %}
			<div id="experiments" class="accordion">
				<div class="card">
					<div class="card-header" id="heading{{exp.id}}" data-toggle="collapse" data-target="#collapse{{exp.id}}">
						<div class="row">
							<a class="col explink" href="{% url 'tardis_portal.view_experiment' exp.id %}">{{ exp.title }}</a>
							<div class="col">
								<ul class="nav nav-pills float-right">
									<li>
										{{ exp|experiment_last_updated_badge }}
									</li>
									<li>
										{{ exp|experiment_datasets_badge }}
									</li>
									<li>
										{{ exp|experiment_datafiles_badge }}
									</li>
									<li>
										{{ exp|experiment_public_access_badge }}
									</li>
								</ul>
							</div>
						</div>
						<div>
							<small>
								{% for author in exp.experimentauthor_set.all %}{% if not forloop.first %}, {% endif %}
								<span property="dc:author">{{ author.author }}</span>{% empty %}&nbsp;{% endfor %}
							</small>
							<span class="float-right">
								{% for dltype, dlurl in exp.get_download_urls.items %}
								{% if forloop.first %}
								<a class="dllink" href="{{dlurl}}"
								title="Download Entire Experiment as {{dltype}}">
								<i class="fa fa-download"></i>
								<em>Download</em>
							</a>
							{% endif %}
							{% endfor %}
						</span>
					</div>
				</div>
				{% if forloop.first %}
				<div id="collapse{{exp.id}}" class="collapse show"  aria-labelledby="#heading{{exp.id}}" data-parent="#experiments">
				{% else %}
				<div id="collapse{{exp.id}}" class="collapse"  aria-labelledby="#heading{{exp.id}}" data-parent="#experiments">
				{% endif %}
				<div class="card-body">
					<p>{{exp.description|default:"<em>No description</em>"|bleach}}</p>
					{% for ds in exp.datasets.all|dictsortreversed:"id"|slice:":5" %}
					{% if forloop.first %}
					<ul class="nav nav-list">
						{% with total=exp.datasets.all|length %}
						<li class="nav-header dataset-list-header">The most recent dataset{{total|pluralize}} in this experiment</li>
						{% endwith %}
						{% endif %}
						<li>
							<a href="{% url 'tardis_portal.view_dataset' ds.id %}">
								<strong>{{ ds.description }}</strong>
							</a>
							{% for datafile in ds.get_images|slice:":5" %}
							{% if forloop.first %}
							<ul class="thumbnails">
								{% endif %}
								<li>
									<a class="thumbnail" href="{% url 'tardis.tardis_portal.download.view_datafile' datafile.id %}">{% url 'tardis.tardis_portal.iiif.download_image' datafile_id=datafile.id region='full' size=',50' rotation=0 quality='native' format='jpg' as thumbnail %}
										<img class="img-thumbnail" alt="Thumbnail for Datafile #{{datafile.id}}" src="{{ thumbnail }}" onerror="$(this).parent().parent().hide()"/>
									</a>
								</li>
								{% if forloop.last %}
							</ul>
							{% endif %}
							{% endfor %}
						</li>
						{% if forloop.last %}
					</ul>
					{% endif %}
					{% endfor %}
				</div>
				</div>
			</div>
		</div>
		{% empty %}
		<p>You have no data stored on this server.<br/>
			<a href="{% url 'tardis.tardis_portal.views.create_experiment' %}">Create
				a new experiment</a> and upload your data</p>
				{% endfor %}
				<br/>
				{% endif %}

				{% with total=public_experiments|length %}
				<h3>The {{ total }} most recent public experiment{{total|pluralize}}</h3>
				{% endwith %}
				{% for exp in public_experiments %}
				<div id="experiments" class="accordion">
					<div class="card">
						<div class="card-header">
							<div class="row">
								<a class="col explink" href="{% url 'tardis_portal.view_experiment' exp.id %}">{{ exp.title }}</a>
								<div class="col">
									<ul class="nav nav-pills float-right">
										<li>
											{{ exp|experiment_last_updated_badge }}
										</li>
										<li>
											{{ exp|experiment_datasets_badge }}
										</li>
										<li>
											{{ exp|experiment_datafiles_badge }}
										</li>
										<li>
											{{ exp|experiment_public_access_badge }}
										</li>
									</ul>
								</div>
							</div>
							<div>
								<small>
									{% for author in exp.experimentauthor_set.all %}{% if not forloop.first %}, {% endif %}
									<span property="dc:author">{{ author.author }}</span>{% empty %}&nbsp;{% endfor %}
								</small>
								<span class="float-right">
									{% for dltype, dlurl in exp.get_download_urls.items %}
									{% if forloop.first %}
									<a class="dllink" href="{{dlurl}}"
									title="Download Entire Experiment as {{dltype}}">
									<i class="fa fa-download"></i>
									<em>Download data as .{{dltype}}</em>
								</a>
								{% endif %}
								{% endfor %}
							</span>
						</div>
					</div>
					<div class="card-body">
						<p>{{exp.description|default:"<em>No description</em>"|bleach}}</p>
						{% for ds in exp.datasets.all|dictsortreversed:"id"|slice:":5" %}
						{% if forloop.first %}
						<ul class="nav nav-list">
							{% with total=exp.datasets.all|length %}
							<li class="nav-header dataset-list-header">The most recent dataset{{total|pluralize}} in this experiment</li>
							{% endwith %}
							{% endif %}
							<li>
								<a href="{% url 'tardis_portal.view_dataset' ds.id %}">
									<strong>{{ ds.description }}</strong>
								</a>
								{% for datafile in ds.get_images|slice:":5" %}
								{% if forloop.first %}
								<ul class="thumbnails">
									{% endif %}
									<li>
										<a class="thumbnail" href="{% url 'tardis.tardis_portal.download.view_datafile' datafile.id %}">{% url 'tardis.tardis_portal.iiif.download_image' datafile_id=datafile.id region='full' size=',50' rotation=0 quality='native' format='jpg' as thumbnail %}
											<img class="img-thumbnail" alt="Thumbnail for Datafile #{{datafile.id}}" src="{{ thumbnail }}" onerror="$(this).parent().parent().hide()"/>
										</a>
									</li>
									{% if forloop.last %}
								</ul>
								{% endif %}
								{% endfor %}
							</li>
							{% if forloop.last %}
						</ul>
						{% endif %}
						{% endfor %}
					</div>
				</div>
			</div>
			{% empty %}
			<p>There is no public data available on this server.</p>
			{% endfor %}
		</div>
	</div>
</div>
</div>
<script type="text/javascript">
	$(function(){
		$("#experiments .accordion-body").collapse({parent:"#experiments", toggle: false});
		$(".explink").click(function(e){
			e.stopPropagation();
		});
		$(".dllink").click(function(e){
			e.stopPropagation();
		});
	});
</script>
{% endblock content %}
